<?xml version="1.0" encoding="UTF-8" ?>
<XMLDB PATH="mod/commitment/db" VERSION="2025112500" COMMENT="Schema for mod_commitment">
  <TABLES>

    <!-- Activity instance (course-level) -->
    <TABLE NAME="commitment" COMMENT="Activity instance (course-level)">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" />
        <FIELD NAME="course" TYPE="int" LENGTH="10" NOTNULL="true" />
        <FIELD NAME="name" TYPE="char" LENGTH="255" NOTNULL="true" />
        <FIELD NAME="intro" TYPE="text" NOTNULL="false" />
        <FIELD NAME="introformat" TYPE="int" LENGTH="4" NOTNULL="false" DEFAULT="0" />
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" />
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="false" />
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="fk_course" TYPE="foreign" FIELDS="course" REFTABLE="course" REFFIELDS="id"/>
      </KEYS>
    </TABLE>

    <!-- User-created contracts inside the activity -->
    <TABLE NAME="commitment_contract" COMMENT="User-created contracts inside the activity">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" />
        <FIELD NAME="commitment" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- FK to commitment.id -->
        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- owner (student) -->
        <FIELD NAME="title" TYPE="char" LENGTH="255" NOTNULL="true" />
        <FIELD NAME="description" TYPE="text" NOTNULL="false" />
        <FIELD NAME="starttime" TYPE="int" LENGTH="10" NOTNULL="false" />
        <FIELD NAME="endtime" TYPE="int" LENGTH="10" NOTNULL="false" />
        <FIELD NAME="periodicity" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="once" />
        <FIELD NAME="visibility" TYPE="int" LENGTH="2" NOTNULL="true" DEFAULT="1" />
        <FIELD NAME="referee" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- referee userid -->
        <FIELD NAME="status" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="active" />
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" />
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="false" />
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="fk_commitment" TYPE="foreign" FIELDS="commitment" REFTABLE="commitment" REFFIELDS="id"/>
        <KEY NAME="fk_user" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
        <KEY NAME="fk_referee" TYPE="foreign" FIELDS="referee" REFTABLE="user" REFFIELDS="id"/>
      </KEYS>
    </TABLE>

    <!-- Periods generated per contract -->
    <TABLE NAME="commitment_period" COMMENT="Periods generated per contract">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" />
        <FIELD NAME="contract" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- FK to commitment_contract.id -->
        <FIELD NAME="periodstart" TYPE="int" LENGTH="10" NOTNULL="true" />
        <FIELD NAME="periodend" TYPE="int" LENGTH="10" NOTNULL="true" />
        <FIELD NAME="status" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="open" />
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" />
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="fk_contract" TYPE="foreign" FIELDS="contract" REFTABLE="commitment_contract" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="contract" UNIQUE="false" FIELDS="status" />
        <INDEX NAME="status" UNIQUE="false" FIELDS="status" />
      </INDEXES>
    </TABLE>

    <!-- Reports submitted by students per period -->
    <TABLE NAME="commitment_report" COMMENT="Reports submitted by students per period">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" />
        <FIELD NAME="period" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- FK to commitment_period.id -->
        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- reporter (usually owner) -->
        <FIELD NAME="reporttext" TYPE="text" NOTNULL="false" />
        <FIELD NAME="evidencefileid" TYPE="int" LENGTH="10" NOTNULL="false" /> <!-- FILES API file id reference -->
        <FIELD NAME="reporttime" TYPE="int" LENGTH="10" NOTNULL="true" />
        <FIELD NAME="status" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="submitted" />
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="fk_period" TYPE="foreign" FIELDS="period" REFTABLE="commitment_period" REFFIELDS="id"/>
        <KEY NAME="fk_user" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
      </KEYS>
    </TABLE>

    <!-- Validations by referee/teacher for each report -->
    <TABLE NAME="commitment_validation" COMMENT="Validations by referee/teacher for each report">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" />
        <FIELD NAME="report" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- FK to commitment_report.id -->
        <FIELD NAME="validator" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- referee or teacher userid -->
        <FIELD NAME="status" TYPE="char" LENGTH="20" NOTNULL="true" DEFAULT="pending" />
        <FIELD NAME="comment" TYPE="text" NOTNULL="false" />
        <FIELD NAME="time" TYPE="int" LENGTH="10" NOTNULL="true" />
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="fk_report" TYPE="foreign" FIELDS="report" REFTABLE="commitment_report" REFFIELDS="id"/>
        <KEY NAME="fk_validator" TYPE="foreign" FIELDS="validator" REFTABLE="user" REFFIELDS="id"/>
      </KEYS>
    </TABLE>

    <!-- Audit log for contract-related actions -->
    <TABLE NAME="commitment_actionlog" COMMENT="Audit log for contract-related actions">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true" />
        <FIELD NAME="contract" TYPE="int" LENGTH="10" NOTNULL="true" /> <!-- FK to commitment_contract.id -->
        <FIELD NAME="action" TYPE="char" LENGTH="50" NOTNULL="true" />
        <FIELD NAME="payload" TYPE="text" NOTNULL="false" /> <!-- JSON blob or short description -->
        <FIELD NAME="time" TYPE="int" LENGTH="10" NOTNULL="true" />
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="fk_contract" TYPE="foreign" FIELDS="contract" REFTABLE="commitment_contract" REFFIELDS="id"/>
      </KEYS>
    </TABLE>
  </TABLES>
</XMLDB>
